<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login Flow Diagram</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body style="margin: 0; padding: 20px; background: #f5f5f5; font-family: Arial, sans-serif;">
    <div style="text-align: center; margin-bottom: 20px;">
        <h1>User Login Flow Architecture</h1>
        <button onclick="downloadPNG()" style="padding: 10px 20px; font-size: 16px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer;">
            ðŸ“¥ Download as PNG
        </button>
    </div>

    <div id="diagram" style="background: white; padding: 40px; margin: 0 auto; width: fit-content; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <svg width="1200" height="1100" style="display: block; margin: 0 auto;">
            <!-- Define markers -->
            <defs>
                <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                    <polygon points="0 0, 10 3, 0 6" fill="#333"/>
                </marker>
                <marker id="arrowhead-red" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                    <polygon points="0 0, 10 3, 0 6" fill="#e74c3c"/>
                </marker>
                <marker id="arrowhead-green" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                    <polygon points="0 0, 10 3, 0 6" fill="#27ae60"/>
                </marker>
            </defs>

            <!-- User Client -->
            <rect x="400" y="20" width="400" height="80" fill="#3498db" stroke="#2c3e50" stroke-width="2" rx="8"/>
            <text x="600" y="50" text-anchor="middle" font-size="18" font-weight="bold" fill="white">USER CLIENT</text>
            <text x="600" y="75" text-anchor="middle" font-size="13" fill="white">(Browser / App / Exam Device)</text>

            <!-- HTTPS Arrow -->
            <line x1="600" y1="100" x2="600" y2="140" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
            <text x="630" y="125" font-size="12" fill="#666">HTTPS / API</text>

            <!-- CDN -->
            <rect x="350" y="140" width="500" height="100" fill="#2ecc71" stroke="#2c3e50" stroke-width="2" rx="8"/>
            <text x="600" y="170" text-anchor="middle" font-size="16" font-weight="bold" fill="white">CDN (Cloudflare)</text>
            <text x="600" y="195" text-anchor="middle" font-size="12" fill="white">â€¢ Caches static responses (optional)</text>
            <text x="600" y="215" text-anchor="middle" font-size="12" fill="white">â€¢ Reduces latency  â€¢ Offloads traffic</text>

            <!-- CDN Miss Arrow -->
            <line x1="600" y1="240" x2="600" y2="280" stroke="#e74c3c" stroke-width="2" marker-end="url(#arrowhead-red)"/>
            <text x="650" y="265" font-size="11" fill="#e74c3c" font-weight="bold">CDN MISS â†’ Cluster</text>

            <!-- NGINX -->
            <rect x="350" y="280" width="500" height="100" fill="#e67e22" stroke="#2c3e50" stroke-width="2" rx="8"/>
            <text x="600" y="310" text-anchor="middle" font-size="16" font-weight="bold" fill="white">Ingress Controller (NGINX)</text>
            <text x="600" y="335" text-anchor="middle" font-size="12" fill="white">â€¢ Rate limit  â€¢ SSL termination  â€¢ Load balancing</text>

            <!-- Load Balancing Arrow -->
            <line x1="600" y1="380" x2="600" y2="420" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
            <text x="660" y="405" font-size="12" fill="#666">Load Balancing</text>

            <!-- Service Label -->
            <rect x="350" y="420" width="500" height="50" fill="#9b59b6" stroke="#2c3e50" stroke-width="2" rx="8"/>
            <text x="600" y="452" text-anchor="middle" font-size="14" font-weight="bold" fill="white">icsquiz-user-service (ClusterIP)</text>

            <!-- Spring Boot Pods -->
            <line x1="600" y1="470" x2="600" y2="510" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
            <text x="620" y="495" font-size="11" fill="#666">Round-Robin</text>

            <!-- Pod Distribution -->
            <rect x="100" y="510" width="160" height="120" fill="#3498db" stroke="#2c3e50" stroke-width="2" rx="6"/>
            <text x="180" y="535" text-anchor="middle" font-size="12" font-weight="bold" fill="white">Pod #1</text>
            <text x="180" y="555" text-anchor="middle" font-size="11" fill="white">Spring Boot</text>
            <text x="180" y="575" text-anchor="middle" font-size="11" fill="white">Virtual Threads</text>

            <rect x="340" y="510" width="160" height="120" fill="#3498db" stroke="#2c3e50" stroke-width="2" rx="6"/>
            <text x="420" y="535" text-anchor="middle" font-size="12" font-weight="bold" fill="white">Pod #2</text>
            <text x="420" y="555" text-anchor="middle" font-size="11" fill="white">Spring Boot</text>
            <text x="420" y="575" text-anchor="middle" font-size="11" fill="white">Virtual Threads</text>

            <rect x="580" y="510" width="160" height="120" fill="#3498db" stroke="#2c3e50" stroke-width="2" rx="6"/>
            <text x="660" y="535" text-anchor="middle" font-size="12" font-weight="bold" fill="white">Pod #3</text>
            <text x="660" y="555" text-anchor="middle" font-size="11" fill="white">Spring Boot</text>
            <text x="660" y="575" text-anchor="middle" font-size="11" fill="white">Virtual Threads</text>

            <rect x="820" y="510" width="160" height="120" fill="#3498db" stroke="#2c3e50" stroke-width="2" rx="6"/>
            <text x="900" y="535" text-anchor="middle" font-size="12" font-weight="bold" fill="white">Pod #N</text>
            <text x="900" y="555" text-anchor="middle" font-size="11" fill="white">Spring Boot</text>
            <text x="900" y="575" text-anchor="middle" font-size="11" fill="white">Virtual Threads</text>

            <!-- Pods to Redis -->
            <line x1="180" y1="630" x2="180" y2="670" stroke="#3498db" stroke-width="2" marker-end="url(#arrowhead)"/>
            <line x1="420" y1="630" x2="420" y2="670" stroke="#3498db" stroke-width="2" marker-end="url(#arrowhead)"/>
            <line x1="660" y1="630" x2="660" y2="670" stroke="#3498db" stroke-width="2" marker-end="url(#arrowhead)"/>
            <line x1="900" y1="630" x2="900" y2="670" stroke="#3498db" stroke-width="2" marker-end="url(#arrowhead)"/>

            <!-- Redis Cache -->
            <rect x="300" y="670" width="600" height="90" fill="#e74c3c" stroke="#2c3e50" stroke-width="2" rx="8"/>
            <text x="600" y="700" text-anchor="middle" font-size="14" font-weight="bold" fill="white">Redis Cache (Get/Set)</text>
            <text x="600" y="725" text-anchor="middle" font-size="12" fill="white">Key: user::{id/email/mobile}  |  Cache Hit â†’ Fast Login</text>

            <!-- Cache Miss to DB -->
            <line x1="300" y1="760" x2="180" y2="800" stroke="#e74c3c" stroke-width="2" marker-end="url(#arrowhead-red)"/>
            <text x="220" y="785" font-size="10" fill="#e74c3c" font-weight="bold">Cache Miss</text>

            <!-- PostgreSQL -->
            <rect x="100" y="800" width="400" height="100" fill="#16a085" stroke="#2c3e50" stroke-width="2" rx="8"/>
            <text x="300" y="830" text-anchor="middle" font-size="14" font-weight="bold" fill="white">PostgreSQL (User Table)</text>
            <text x="300" y="855" text-anchor="middle" font-size="12" fill="white">Check credentials / status / roles</text>
            <text x="300" y="880" text-anchor="middle" font-size="12" fill="white">Store in Redis for next login</text>

            <!-- Redis Write -->
            <line x1="400" y1="800" x2="550" y2="760" stroke="#27ae60" stroke-width="2" marker-end="url(#arrowhead-green)"/>
            <text x="510" y="775" font-size="10" fill="#27ae60" font-weight="bold">Write to Cache</text>

            <!-- Create Login Event -->
            <rect x="700" y="800" width="400" height="100" fill="#f39c12" stroke="#2c3e50" stroke-width="2" rx="8"/>
            <text x="900" y="830" text-anchor="middle" font-size="14" font-weight="bold" fill="white">Create Login Event (JSON)</text>
            <text x="900" y="860" text-anchor="middle" font-size="12" fill="white">User ID, Timestamp, IP, Device</text>

            <!-- Event to RabbitMQ -->
            <line x1="900" y1="900" x2="900" y2="940" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>

            <!-- RabbitMQ -->
            <rect x="700" y="940" width="400" height="100" fill="#c0392b" stroke="#2c3e50" stroke-width="2" rx="8"/>
            <text x="900" y="970" text-anchor="middle" font-size="14" font-weight="bold" fill="white">RabbitMQ (Message Bus)</text>
            <text x="900" y="995" text-anchor="middle" font-size="12" fill="white">exchange: login.events</text>

            <!-- Consumers -->
            <line x1="700" y1="1040" x2="500" y2="1080" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
            <line x1="900" y1="1040" x2="900" y2="1080" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
            <line x1="1100" y1="1040" x2="1300" y2="1080" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>

            <text x="900" y="1065" text-anchor="middle" font-size="11" fill="#333" font-weight="bold">Consumers process events:</text>

            <!-- Consumer Services -->
            <rect x="350" y="1080" width="150" height="80" fill="#8e44ad" stroke="#2c3e50" stroke-width="2" rx="6"/>
            <text x="425" y="1105" text-anchor="middle" font-size="12" font-weight="bold" fill="white">Analytics</text>
            <text x="425" y="1125" text-anchor="middle" font-size="11" fill="white">Store login</text>
            <text x="425" y="1145" text-anchor="middle" font-size="11" fill="white">logs</text>

            <rect x="625" y="1080" width="150" height="80" fill="#8e44ad" stroke="#2c3e50" stroke-width="2" rx="6"/>
            <text x="700" y="1105" text-anchor="middle" font-size="12" font-weight="bold" fill="white">Logs Service</text>
            <text x="700" y="1125" text-anchor="middle" font-size="11" fill="white">Write DB</text>
            <text x="700" y="1145" text-anchor="middle" font-size="11" fill="white">logs</text>

            <rect x="900" y="1080" width="150" height="80" fill="#8e44ad" stroke="#2c3e50" stroke-width="2" rx="6"/>
            <text x="975" y="1105" text-anchor="middle" font-size="12" font-weight="bold" fill="white">Notification</text>
            <text x="975" y="1125" text-anchor="middle" font-size="11" fill="white">Email/SMS</text>
            <text x="975" y="1145" text-anchor="middle" font-size="11" fill="white">alert</text>
        </svg>
    </div>

    <script>
        async function downloadPNG() {
            const diagram = document.getElementById('diagram');
            const canvas = await html2canvas(diagram, {
                backgroundColor: '#ffffff',
                scale: 2,
                logging: false
            });
            
            const link = document.createElement('a');
            link.href = canvas.toDataURL('image/png');
            link.download = 'User-Login-Flow-Diagram.png';
            link.click();
        }
    </script>
</body>
</html>