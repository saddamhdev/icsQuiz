<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Architecture</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body style="margin: 0; padding: 20px; background: #f5f5f5; font-family: Arial, sans-serif;">
    <div style="text-align: center; margin-bottom: 20px;">
        <h1>System Architecture Diagram</h1>
        <button onclick="downloadPNG()" style="padding: 10px 20px; font-size: 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
            Download as PNG
        </button>
    </div>

    <div id="diagram" style="background: white; padding: 40px; margin: 0 auto; width: fit-content; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <svg width="900" height="700" style="display: block; margin: 0 auto;">
            <!-- CDN -->
            <rect x="350" y="20" width="200" height="60" fill="#4CAF50" stroke="#333" stroke-width="2" rx="4"/>
            <text x="450" y="55" text-anchor="middle" font-size="16" font-weight="bold" fill="white">CDN (Cloudflare)</text>

            <!-- Arrow down -->
            <line x1="450" y1="80" x2="450" y2="120" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>

            <!-- NGINX Ingress -->
            <rect x="325" y="120" width="250" height="60" fill="#FF9800" stroke="#333" stroke-width="2" rx="4"/>
            <text x="450" y="155" text-anchor="middle" font-size="16" font-weight="bold" fill="white">NGINX Ingress</text>

            <!-- Arrows down and split -->
            <line x1="450" y1="180" x2="450" y2="220" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
            <line x1="220" y1="220" x2="680" y2="220" stroke="#333" stroke-width="2"/>
            <line x1="220" y1="220" x2="220" y2="260" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
            <line x1="680" y1="220" x2="680" y2="260" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>

            <!-- Login + Analytics Service -->
            <rect x="80" y="260" width="280" height="120" fill="#2196F3" stroke="#333" stroke-width="2" rx="4"/>
            <text x="220" y="285" text-anchor="middle" font-size="14" font-weight="bold" fill="white">Login + Analytics Service</text>
            <text x="220" y="310" text-anchor="middle" font-size="12" fill="white">• Login API</text>
            <text x="220" y="330" text-anchor="middle" font-size="12" fill="white">• MCQ Load</text>
            <text x="220" y="350" text-anchor="middle" font-size="12" fill="white">• Event Tracking</text>

            <!-- Submission Service -->
            <rect x="540" y="260" width="280" height="120" fill="#2196F3" stroke="#333" stroke-width="2" rx="4"/>
            <text x="680" y="285" text-anchor="middle" font-size="14" font-weight="bold" fill="white">Submission Service</text>
            <text x="680" y="310" text-anchor="middle" font-size="12" fill="white">• Submit Answer</text>
            <text x="680" y="330" text-anchor="middle" font-size="12" fill="white">• Validate Input</text>
            <text x="680" y="350" text-anchor="middle" font-size="12" fill="white">• Publish Queue</text>

            <!-- Arrows to RabbitMQ -->
            <line x1="220" y1="380" x2="220" y2="420" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
            <text x="245" y="410" font-size="11" fill="#666">Publish Events</text>

            <line x1="680" y1="380" x2="680" y2="420" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
            <text x="705" y="410" font-size="11" fill="#666">Consume Events</text>

            <!-- RabbitMQ -->
            <rect x="160" y="420" width="120" height="60" fill="#9C27B0" stroke="#333" stroke-width="2" rx="4"/>
            <text x="220" y="455" text-anchor="middle" font-size="14" font-weight="bold" fill="white">RabbitMQ</text>

            <!-- Submission Workers -->
            <rect x="600" y="420" width="160" height="60" fill="#F44336" stroke="#333" stroke-width="2" rx="4"/>
            <text x="680" y="455" text-anchor="middle" font-size="14" font-weight="bold" fill="white">Submission Workers</text>

            <!-- Batching arrow between RabbitMQ and Workers -->
            <line x1="280" y1="450" x2="600" y2="450" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)" marker-start="url(#arrowhead)"/>
            <text x="440" y="440" text-anchor="middle" font-size="11" fill="#666">batching</text>

            <!-- Arrow from Workers down -->
            <line x1="680" y1="480" x2="680" y2="520" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
            <text x="705" y="510" font-size="11" fill="#666">DB Writes</text>

            <!-- Arrow from RabbitMQ left to Redis -->
            <line x1="160" y1="450" x2="100" y2="450" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>

            <!-- Redis -->
            <rect x="20" y="420" width="80" height="60" fill="#E91E63" stroke="#333" stroke-width="2" rx="4"/>
            <text x="60" y="455" text-anchor="middle" font-size="14" font-weight="bold" fill="white">Redis</text>

            <!-- PostgreSQL / TimescaleDB -->
            <rect x="540" y="520" width="280" height="80" fill="#00BCD4" stroke="#333" stroke-width="2" rx="4"/>
            <text x="680" y="550" text-anchor="middle" font-size="14" font-weight="bold" fill="white">PostgreSQL /</text>
            <text x="680" y="575" text-anchor="middle" font-size="14" font-weight="bold" fill="white">TimescaleDB</text>

            <!-- Arrow marker definition -->
            <defs>
                <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                    <polygon points="0 0, 10 3, 0 6" fill="#333"/>
                </marker>
            </defs>
        </svg>
    </div>

    <script>
        async function downloadPNG() {
            const diagram = document.getElementById('diagram');
            const canvas = await html2canvas(diagram, {
                backgroundColor: '#ffffff',
                scale: 2,
                logging: false
            });
            
            const link = document.createElement('a');
            link.href = canvas.toDataURL('image/png');
            link.download = 'architecture-diagram.png';
            link.click();
        }
    </script>
</body>
</html>